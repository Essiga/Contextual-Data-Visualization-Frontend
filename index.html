<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KUKA Visualization</title>
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body style="background-color: rgba(18,0,20,0.94); margin: 0px;">

<nav class="navbar">
    <ul class="nav-list">
        <li class="nav-item"><a href="#home">KUKA Visualization</a></li>
    </ul>
</nav>
<!--<ul>-->
<!--    <li style="margin-left: 5%"><a class="active"></a> Kuka Visualization</li>-->
<!--</ul>-->
<div style="padding-left: 5%; padding-right: 5%">

    <!--<div>-->
    <!--    <h1>Kuka Visualization</h1>-->
    <!--</div>-->

    <div style="padding-left:20px; display: flex; width: 25%; min-width: 600px; background-color: #12001a; height: 80px; margin-top: 20px; margin-bottom: 20px">
        <div style="flex:1;  align-self: center; ">
            <p>from</p>
        </div>
        <div style="flex:1;  align-self: center; margin-right: 10%; margin-left: 20px">
            <input id="startDateTimePicker"/>
        </div>
        <div style=" flex:1; align-self: center;">
            <p>till</p>
        </div>
        <div style=" flex:1; align-self: center; margin-right: 10%; margin-left: 20px">
            <input id="endDateTimePicker"/>
        </div>
    </div>
    <div id="measurements" style="padding-left:20px; display: flex; width: 25%; min-width: 600px; background-color: #12001a; height: 80px; margin-top: 20px; margin-bottom: 20px">
        <div style="flex:1;  align-self: center; ">
            <p>Measurement</p>
        </div>
        <div style="align-self: center; margin-right: 10%; margin-left: 20px; width: 3100px">
            <select name="cars" id="kukaInstructions">
                <option value="volvo">Volvo</option>
                <option value="saab">Saabsadjfl ajdskfjdsa jflkdsa jfkajds lfj</option>
                <option value="opel">Opel</option>
                <option value="audi">Audi</option>
            </select>
        </div>
    </div>

    <div id="lineChart">

    </div>
</div>
</body>
</html>

<Script>

    let kukaInstructions = [];

    $( document ).ready(function() {
        document.getElementById('kukaInstructions').onchange = function () {
           let select = document.getElementById("kukaInstructions");
           console.log(kukaInstructions[select.value]);
           if(select.value != -1){
               fetchChartData();
           }
        };
        $("#measurements").hide();

    });

    function fetchChartData(){
        fetch('http://localhost:8080/rest/questdb/movement/getByTimeFrame', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "startDate": kukaInstructions[document.getElementById("kukaInstructions").value].startTimeStamp,
                "endDate": kukaInstructions[document.getElementById("kukaInstructions").value].endTimeStamp
            })
        })
            .then(response => response.json())
            .then(response => {
                //console.log(JSON.stringify(response))

                for (let i = 0; i < response.length; i++) {
                    let test = response[i].Values_Actual_TCP_pose.substring(1, response[i].Values_Actual_TCP_pose.length - 1).split(',').map(parseFloat);
                    //yData[i] = response[i].ValuesActual_q.substring(1, response[i].length - 1).split(',').map(parseFloat)[0];
                    yData[i] = test[0] * (180/Math.PI);


                    const dateTimeStamp = new Date(response[i].Values_TS_PLC / 1000); // Divide by 1000 to convert microseconds to milliseconds

                    //const formattedDate = dateTimeStamp.toISOString().replace('Z', `${(response[i].Values_TS_PLC % 1000).toString().padStart(3, '0')}Z`);
                    let tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
                    var localISOTime = (new Date(dateTimeStamp - tzoffset)).toISOString();
                    const formattedDate = localISOTime.replace('Z', `${(response[i].Values_TS_PLC % 1000).toString().padStart(3, '0')}Z`);

                    //xData[i] = response[i].Values_TS_PLC;
                    //const str = new Date().toLocaleString('en-US', { timeZone: 'Europe/Vienna' });

                    xData[i] = formattedDate;

                }
                console.log(xData);
                Plotly.newPlot('lineChart', data, layout);
            })


        fetch('http://localhost:8080/rest/questdb/energy/getByTimeFrame', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "startDate": kukaInstructions[document.getElementById("kukaInstructions").value].startTimeStamp,
                "endDate": kukaInstructions[document.getElementById("kukaInstructions").value].endTimeStamp
            })
        })
            .then(response => response.json())
            .then(response => {
                //console.log(JSON.stringify(response))

                for (let i = 0; i < response.length; i++) {
                    let test = response[i].Values_I_RMS.substring(1, response[i].Values_I_RMS.length - 1).split(',').map(parseFloat);
                    //yData[i] = response[i].Values_Actual_q.substring(1, response[i].length - 1).split(',').map(parseFloat)[0];
                    yEnergyData[i] = test[0];

                    let ts = ((response[i].Values_TS / 10000) - 11644473600000);

                    const dateTimeStamp = new Date(ts);

                    let tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
                    var localISOTime = (new Date(dateTimeStamp - tzoffset)).toISOString();
                    const formattedDate = localISOTime.replace('Z', `${(ts % 1000).toString().padStart(3, '0')}Z`);
                    //const formattedDate = dateTimeStamp.toISOString().replace('Z', `${(ts % 1000).toString().padStart(3, '0')}Z`);

                    //xEnergyData[i] = ((response[i].Values_TS / 10000) - 11644473600000) * 1000;
                    xEnergyData[i] = formattedDate;


                }
                console.log("energy")
                console.log(xEnergyData);
                //Plotly.newPlot('lineChart', data, layout);
            })

        Plotly.newPlot('lineChart', data, layout);
    }

    $( "#startDateTimePicker" ).change(function() {
         if( $("#endDateTimePicker").val() !== ""){
            fetchKukaInstructions()
        }
    });
    $( "#endDateTimePicker" ).change(function() {
        if( $("#startDateTimePicker").val() !== ""){
            fetchKukaInstructions()
        }
    });

    //get data from server
    function fetchKukaInstructions(){
        fetch('http://localhost:8080/rest/mongodb/getByTimeFrame', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "startDate": new Date($("#startDateTimePicker").val()).toISOString(),
                "endDate": new Date($("#endDateTimePicker").val()).toISOString()
            })
        }).then(response => response.json())
            .then(response => {
                console.log(JSON.stringify(response))
                let select = document.getElementById("kukaInstructions");
                while(select.firstChild){
                    select.removeChild(select.firstChild);
                }
                let element = document.createElement("option");
                element.textContent = "none";
                element.value = -1;
                select.append(element);
                kukaInstructions = response;
                for(let i = 0; i < response.length; i++){
                    var date = new Date(0);
                    date.setUTCSeconds(response[i].startTimeStamp)
                    let el = document.createElement("option");
                    el.textContent = response[i].name + " BearingPos: " +  response[i].trayPosBearing + " CapPos: "+ response[i].trayPosCap + " StartTime: " +  date.toLocaleString();
                    //save the index array as value this way it's possible to just access the correct object by index.
                    el.value = i;
                    select.appendChild(el);
                }
                $("#measurements").show();

            })

    }

    flatpickr("#startDateTimePicker", {
        enableTime: true,
        enableSeconds: true,
        dateFormat: "Y-m-d H:i:S",
        time_24hr: true
    })
    flatpickr("#endDateTimePicker", {
        enableTime: true,
        enableSeconds: true,
        dateFormat: "Y-m-d H:i:S",
        time_24hr: true
    })

    let xData = [];
    let xEnergyData = [];
    let yData = [];
    let yEnergyData = [];



    // Define your chart data
    var data = [
        {
            x: xData,
            y: yData,
            mode: 'lines',
            marker: {
                color: 'white' // Set marker color to white
            },
            name: "movement"
        },
        {
            x: xEnergyData,
            y: yEnergyData,
            mode: 'lines',
            marker: {
                color: "green"
            },
            name: "energy"
        }
    ];

    //Define your chart layout
    var layout = {
        plot_bgcolor: '#12001a', // Set plot background color to black
        paper_bgcolor: '#12001a', // Set paper background color to black
        font: {
            color: 'white' // Set font color to white
        },
        title: {
            text: 'KUKA Chart' // Set chart title
        },
        xaxis: {
            gridcolor: '#4c3457', // Set x-axis grid color to white
        },
        yaxis: {
            gridcolor: '#4c3457' // Set y-axis grid color to white
        }
    };

    // Create the chart
    //Plotly.newPlot('lineChart', data);


    // var trace1 = {
    //     x: [1, 2, 3, 4],
    //     y: [10, 15, 13, 17],
    //     type: 'scatter'
    // };
    //
    // var trace2 = {
    //     x: [1, 2, 3, 4],
    //     y: [16, 5, 11, 9],
    //     type: 'scatter'
    // };
    //
    // var data = [trace1, trace2];
    //
    //
    // Plotly.newPlot('lineChart', data);

    Plotly.newPlot('lineChart', data, layout);

    var chart = document.getElementById('lineChart');

    // Add event listener for 'plotly_afterplot' event

    // chart.on('plotly_click', function() {
    //     var xRange =  chart.layout.xaxis.range;
    //     console.log("test")
    //     // Calculate the difference between the maximum and minimum x-axis values
    //     var xDiff = xRange[1] - xRange[0];
    //
    //     let update = {
    //         mode: 'lines+markers',
    //     }
    //     Plotly.restyle(chart, update, 0)
    //
    //     // // Set the visibility of markers based on the x-axis range
    //     // if (xDiff <= 2) {
    //     //     Plotly.updateTraces('lineChart', {mode: "lines"}); // Hide markers if xDiff <= 2
    //     // } else {
    //     //     Plotly.updateTraces('lineChart', {mode: "lines+markers"}); // Show markers if xDiff > 2
    //     // }
    // })

    // chart.then(function() {
    //     setTimeout(function(){
    //         // Get the x-axis range
    //         var xRange =  chart.layout.xaxis.range;
    //
    //         // Calculate the difference between the maximum and minimum x-axis values
    //         var xDiff = xRange[1] - xRange[0];
    //
    //         // Set the visibility of markers based on the x-axis range
    //         if (xDiff <= 2) {
    //             Plotly.updateTraces('lineChart', {mode: "lines"}); // Hide markers if xDiff <= 2
    //         } else {
    //             Plotly.updateTraces('lineChart', {mode: "lines+markers"}); // Show markers if xDiff > 2
    //         }
    //     }, 1000);
    //
    // });

</Script>